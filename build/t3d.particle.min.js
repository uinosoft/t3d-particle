// t3d-particle
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d=t.t3d||{},t.t3d)}(this,(function(t,e){"use strict";function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var i=r(e),a={distributions:{BOX:1,SPHERE:2,DISC:3,LINE:4},valueOverLifetimeLength:4};function o(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(a=i.key,o=void 0,"symbol"==typeof(o=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(a,"string"))?o:String(o)),i)}var a,o}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,s(t,e)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}var l,u,c,f={types:{BOOLEAN:"boolean",STRING:"string",NUMBER:"number",OBJECT:"object"},ensureTypedArg:function(t,e,r){return typeof t===e?t:r},ensureArrayTypedArg:function(t,e,r){if(Array.isArray(t)){for(var i=t.length-1;i>=0;--i)if(typeof t[i]!==e)return r;return t}return this.ensureTypedArg(t,e,r)},ensureInstanceOf:function(t,e,r){return void 0!==e&&t instanceof e?t:r},ensureArrayInstanceOf:function(t,e,r){if(Array.isArray(t)){for(var i=t.length-1;i>=0;--i)if(void 0!==e&&t[i]instanceof e==!1)return r;return t}return this.ensureInstanceOf(t,e,r)},ensureValueOverLifetimeCompliance:function(t,e,r){e=e||3,r=r||3,!1===Array.isArray(t._value)&&(t._value=[t._value]),!1===Array.isArray(t._spread)&&(t._spread=[t._spread]);var i=this.clamp(t._value.length,e,r),a=this.clamp(t._spread.length,e,r),o=Math.max(i,a);t._value.length!==o&&(t._value=this.interpolateArray(t._value,o)),t._spread.length!==o&&(t._spread=this.interpolateArray(t._spread,o))},interpolateArray:function(t,e){for(var r=t.length,i=["function"==typeof t[0].clone?t[0].clone():t[0]],a=(r-1)/(e-1),o=1;o<e-1;++o){var n=o*a,s=Math.floor(n),l=Math.ceil(n),u=n-s;i[o]=this.lerpTypeAgnostic(t[s],t[l],u)}return i.push("function"==typeof t[r-1].clone?t[r-1].clone():t[r-1]),i},clamp:function(t,e,r){return Math.max(e,Math.min(t,r))},zeroToEpsilon:function(t,e){var r=1e-5,i=t;return i=e?Math.random()*r*10:r,t<0&&t>-1e-5&&(i=-i),i},lerpTypeAgnostic:function(t,e,r){var a,o=this.types;return typeof t===o.NUMBER&&typeof e===o.NUMBER?t+(e-t)*r:t instanceof i.Vector2&&e instanceof i.Vector2||typeof t.x==o.NUMBER&&typeof t.y==o.NUMBER&&null==t.z&&null==t.z&&typeof e.x==o.NUMBER&&typeof e.y==o.NUMBER&&null==e.z&&null==e.z?(t instanceof i.Vector2?a=(new i.Vector2).copy(t):((a={}).x=t.x,a.y=t.y),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a):t instanceof i.Vector3&&e instanceof i.Vector3||typeof t.x==o.NUMBER&&typeof t.y==o.NUMBER&&typeof t.z==o.NUMBER&&null==t.w&&null==t.w&&typeof e.x==o.NUMBER&&typeof e.y==o.NUMBER&&typeof e.z==o.NUMBER&&null==e.w&&null==e.w?(t instanceof i.Vector3?a=(new i.Vector3).copy(t):((a={}).x=t.x,a.y=t.y,a.z=t.z),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a.z=this.lerp(t.z,e.z,r),a):t instanceof i.Vector4&&e instanceof i.Vector4||typeof t.x==o.NUMBER&&typeof t.y==o.NUMBER&&typeof t.z==o.NUMBER&&typeof t.w==o.NUMBER&&typeof e.x==o.NUMBER&&typeof e.y==o.NUMBER&&typeof e.z==o.NUMBER&&typeof e.w==o.NUMBER?(t instanceof i.Vector3?a=(new i.Vector4).copy(t):((a={}).x=t.x,a.y=t.y,a.z=t.z,a.w=t.w),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a.z=this.lerp(t.z,e.z,r),a.w=this.lerp(t.w,e.w,r),a):t instanceof i.Color3&&e instanceof i.Color3||typeof t.r==o.NUMBER&&typeof t.g==o.NUMBER&&typeof t.b==o.NUMBER&&typeof e.r==o.NUMBER&&typeof e.g==o.NUMBER&&typeof e.b==o.NUMBER?(t instanceof i.Vector3?a=(new i.Color3).copy(t):((a={}).r=t.r,a.g=t.g,a.b=t.b),a.r=this.lerp(t.r,e.r,r),a.g=this.lerp(t.g,e.g,r),a.b=this.lerp(t.b,e.b,r),a):void console.warn("Invalid argument types, or argument types do not match:",t,e)},lerp:function(t,e,r){return t+(e-t)*r},roundToNearestMultiple:function(t,e){var r;return 0===e||0===(r=Math.abs(t)%e)?t:t<0?-(Math.abs(t)-r):t+e-r},arrayValuesAreEqual:function(t){for(var e=0;e<t.length-1;++e)if(t[e]!==t[e+1])return!1;return!0},randomFloat:function(t,e){return t+e*(Math.random()-.5)},getRandomVector3:function(t,e,r,i,a){var o=r.x+(Math.random()*i.x-.5*i.x),n=r.y+(Math.random()*i.y-.5*i.y),s=r.z+(Math.random()*i.z-.5*i.z);return a&&(o=.5*-a.x+this.roundToNearestMultiple(o,a.x),n=.5*-a.y+this.roundToNearestMultiple(n,a.y),s=.5*-a.z+this.roundToNearestMultiple(s,a.z)),t[e+0]=o,t[e+1]=n,t[e+2]=s,t},getRandomVector3OnSphere:function(t,e,r,i,a,o,n){var s=2*Math.random()-1,l=6.2832*Math.random(),u=Math.sqrt(1-s*s),c=this.randomFloat(i,a),f=0,h=0,p=0;return n&&(c=Math.round(c/n)*n),f=u*Math.cos(l)*c,h=u*Math.sin(l)*c,p=s*c,f*=o.x,h*=o.y,p*=o.z,f+=r.x,h+=r.y,p+=r.z,t[e+0]=f,t[e+1]=h,t[e+2]=p,t},getRandomVector3OnDisc:function(t,e,r,i,a,o,n){var s=6.2832*Math.random(),l=Math.abs(this.randomFloat(i,a)),u=0,c=0,f=0;return n&&(l=Math.round(l/n)*n),u=Math.cos(s)*l,c=Math.sin(s)*l,u*=o.x,c*=o.y,u+=r.x,c+=r.y,f+=r.z,t[e+0]=u,t[e+1]=c,t[e+2]=f,t},getRandomVector3OnLine:(c=new i.Vector3,function(t,e,r,i){return c.lerpVectors(r,i,Math.random()),c.toArray(t,e),t}),getRandomDirectionVector3OnSphere:(u=new i.Vector3,function(t,e,r,i,a,o,n,s){return u.copy(o),u.x-=r,u.y-=i,u.z-=a,u.normalize().multiplyScalar(-this.randomFloat(n,s)),u.toArray(t,e),t}),getRandomDirectionVector3OnDisc:function(){var t=new i.Vector3;return function(e,r,i,a,o,n,s,l){return t.copy(n),t.x-=i,t.y-=a,t.z-=o,t.normalize().multiplyScalar(-this.randomFloat(s,l)),t.toArray(e,r),e[r+2]=0,e}}(),getRotationAxis:(l=new i.Vector3,function(t,e,r){return t.copy(e).normalize(),l.copy(r).normalize(),t.x+=.5*-r.x+Math.random()*r.x,t.y+=.5*-r.y+Math.random()*r.y,t.z+=.5*-r.z+Math.random()*r.z,t.normalize(),t})},h={defines:["#define PACKED_COLOR_SIZE 256.0","#define PACKED_COLOR_DIVISOR 255.0"].join("\n"),uniforms:["uniform float deltaTime;","uniform float runTime;","uniform sampler2D tex;","uniform vec4 textureAnimation;","uniform float scale;"].join("\n"),attributes:["attribute vec4 acceleration;","attribute vec3 velocity;","attribute vec4 rotation;","attribute vec3 rotationCenter;","attribute vec4 params;","attribute vec4 size;","attribute vec4 angle;","attribute vec4 color;","attribute vec4 opacity;"].join("\n"),varyings:["varying vec4 vColor;","#ifdef SHOULD_ROTATE_TEXTURE","\t\tvarying float vAngle;","#endif","#ifdef SHOULD_CALCULATE_SPRITE","\t\tvarying vec4 vSpriteSheet;","#endif"].join("\n"),branchAvoidanceFunctions:["float when_gt(float x, float y) {","\t\treturn max(sign(x - y), 0.0);","}","float when_lt(float x, float y) {","\t\treturn min( max(1.0 - sign(x - y), 0.0), 1.0 );","}","float when_eq( float x, float y ) {","\t\treturn 1.0 - abs( sign( x - y ) );","}","float when_ge(float x, float y) {","\treturn 1.0 - when_lt(x, y);","}","float when_le(float x, float y) {","\treturn 1.0 - when_gt(x, y);","}","float and(float a, float b) {","\t\treturn a * b;","}","float or(float a, float b) {","\t\treturn min(a + b, 1.0);","}"].join("\n"),unpackColor:["vec3 unpackColor( in float hex ) {","\t vec3 c = vec3( 0.0 );","\t float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float b = mod( hex, PACKED_COLOR_SIZE );","\t c.r = r / PACKED_COLOR_DIVISOR;","\t c.g = g / PACKED_COLOR_DIVISOR;","\t c.b = b / PACKED_COLOR_DIVISOR;","\t return c;","}"].join("\n"),unpackRotationAxis:["vec3 unpackRotationAxis( in float hex ) {","\t vec3 c = vec3( 0.0 );","\t float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float b = mod( hex, PACKED_COLOR_SIZE );","\t c.r = r / PACKED_COLOR_DIVISOR;","\t c.g = g / PACKED_COLOR_DIVISOR;","\t c.b = b / PACKED_COLOR_DIVISOR;","\t c *= vec3( 2.0 );","\t c -= vec3( 1.0 );","\t return c;","}"].join("\n"),floatOverLifetime:["float getFloatOverLifetime( in float positionInTime, in vec4 attr ) {","\t\thighp float value = 0.0;","\t\tfloat deltaAge = positionInTime * float( VALUE_OVER_LIFETIME_LENGTH - 1 );","\t\tfloat fIndex = 0.0;","\t\tfloat shouldApplyValue = 0.0;","\t\tvalue += attr[ 0 ] * when_eq( deltaAge, 0.0 );","","\t\tfor( int i = 0; i < VALUE_OVER_LIFETIME_LENGTH - 1; ++i ) {","\t\t\t fIndex = float( i );","\t\t\t shouldApplyValue = and( when_gt( deltaAge, fIndex ), when_le( deltaAge, fIndex + 1.0 ) );","\t\t\t value += shouldApplyValue * mix( attr[ i ], attr[ i + 1 ], deltaAge - fIndex );","\t\t}","","\t\treturn value;","}"].join("\n"),colorOverLifetime:["vec3 getColorOverLifetime( in float positionInTime, in vec3 color1, in vec3 color2, in vec3 color3, in vec3 color4 ) {","\t\tvec3 value = vec3( 0.0 );","\t\tvalue.x = getFloatOverLifetime( positionInTime, vec4( color1.x, color2.x, color3.x, color4.x ) );","\t\tvalue.y = getFloatOverLifetime( positionInTime, vec4( color1.y, color2.y, color3.y, color4.y ) );","\t\tvalue.z = getFloatOverLifetime( positionInTime, vec4( color1.z, color2.z, color3.z, color4.z ) );","\t\treturn value;","}"].join("\n"),paramFetchingFunctions:["float getAlive() {","\t return params.x;","}","float getAge() {","\t return params.y;","}","float getMaxAge() {","\t return params.z;","}","float getWiggle() {","\t return params.w;","}"].join("\n"),forceFetchingFunctions:["vec4 getPosition( in float age ) {","\t return u_View * u_Model * vec4( a_Position, 1.0 );","}","vec3 getVelocity( in float age ) {","\t return velocity * age;","}","vec3 getAcceleration( in float age ) {","\t return acceleration.xyz * age;","}"].join("\n"),rotationFunctions:["#ifdef SHOULD_ROTATE_PARTICLES","\t mat4 getRotationMatrix( in vec3 axis, in float angle) {","\t\t\t axis = normalize(axis);","\t\t\t float s = sin(angle);","\t\t\t float c = cos(angle);","\t\t\t float oc = 1.0 - c;","","\t\t\t return mat4(oc * axis.x * axis.x + c,\t\t\t\t\t oc * axis.x * axis.y - axis.z * s,\toc * axis.z * axis.x + axis.y * s,\t0.0,","\t\t\t\t\t\t\t\t\t oc * axis.x * axis.y + axis.z * s,\toc * axis.y * axis.y + c,\t\t\t\t\t oc * axis.y * axis.z - axis.x * s,\t0.0,","\t\t\t\t\t\t\t\t\t oc * axis.z * axis.x - axis.y * s,\toc * axis.y * axis.z + axis.x * s,\toc * axis.z * axis.z + c,\t\t\t\t\t 0.0,","\t\t\t\t\t\t\t\t\t 0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0);","\t }","","\t vec3 getRotation( in vec3 pos, in float positionInTime ) {","\t\t\tif( rotation.y == 0.0 ) {","\t\t\t\t\t return pos;","\t\t\t}","","\t\t\tvec3 axis = unpackRotationAxis( rotation.x );","\t\t\tvec3 center = rotationCenter;","\t\t\tvec3 translated;","\t\t\tmat4 rotationMatrix;","\t\t\tfloat angle = 0.0;","\t\t\tangle += when_eq( rotation.z, 0.0 ) * rotation.y;","\t\t\tangle += when_gt( rotation.z, 0.0 ) * mix( 0.0, rotation.y, positionInTime );","\t\t\ttranslated = rotationCenter - pos;","\t\t\trotationMatrix = getRotationMatrix( axis, angle );","\t\t\treturn center - vec3( rotationMatrix * vec4( translated, 0.0 ) );","\t }","#endif"].join("\n"),rotateTexture:["\t\tvec2 vUv = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","","\t\t#ifdef SHOULD_ROTATE_TEXTURE","\t\t\t float x = gl_PointCoord.x - 0.5;","\t\t\t float y = 1.0 - gl_PointCoord.y - 0.5;","\t\t\t float c = cos( -vAngle );","\t\t\t float s = sin( -vAngle );","\t\t\t vUv = vec2( c * x + s * y + 0.5, c * y - s * x + 0.5 );","\t\t#endif","","\t\t#ifdef SHOULD_CALCULATE_SPRITE","\t\t\t\tfloat framesX = vSpriteSheet.x;","\t\t\t\tfloat framesY = vSpriteSheet.y;","\t\t\t\tfloat columnNorm = vSpriteSheet.z;","\t\t\t\tfloat rowNorm = vSpriteSheet.w;","\t\t\t\tvUv.x = gl_PointCoord.x * framesX + columnNorm;","\t\t\t\tvUv.y = 1.0 - (gl_PointCoord.y * framesY + rowNorm);","\t\t#endif","","\t\tvec4 rotatedTexture = texture2D( tex, vUv );"].join("\n")},p={vertex:[h.defines,h.uniforms,h.attributes,h.varyings,i.ShaderChunk.common_vert,i.ShaderChunk.logdepthbuf_pars_vert,h.branchAvoidanceFunctions,h.unpackColor,h.unpackRotationAxis,h.floatOverLifetime,h.colorOverLifetime,h.paramFetchingFunctions,h.forceFetchingFunctions,h.rotationFunctions,"void main() {","\t\thighp float age = getAge();","\t\thighp float alive = getAlive();","\t\thighp float maxAge = getMaxAge();","\t\thighp float positionInTime = (age / maxAge);","\t\thighp float isAlive = when_gt( alive, 0.0 );","\t\t#ifdef SHOULD_WIGGLE_PARTICLES","\t\t\t\tfloat wiggleAmount = positionInTime * getWiggle();","\t\t\t\tfloat wiggleSin = isAlive * sin( wiggleAmount );","\t\t\t\tfloat wiggleCos = isAlive * cos( wiggleAmount );","\t\t#endif","\t\tvec3 vel = getVelocity( age );","\t\tvec3 accel = getAcceleration( age );","\t\tvec3 force = vec3( 0.0 );","\t\tvec3 pos = vec3( a_Position );","\t\tfloat drag = 1.0 - (positionInTime * 0.5) * acceleration.w;","\t\tforce += vel;","\t\tforce *= drag;","\t\tforce += accel * age;","\t\tpos += force;","\t\t#ifdef SHOULD_WIGGLE_PARTICLES","\t\t\t\tpos.x += wiggleSin;","\t\t\t\tpos.y += wiggleCos;","\t\t\t\tpos.z += wiggleSin;","\t\t#endif","\t\t#ifdef SHOULD_ROTATE_PARTICLES","\t\t\t\tpos = getRotation( pos, positionInTime );","\t\t#endif","\t\tvec4 mvPosition = u_View * u_Model * vec4( pos, 1.0 );","\t\thighp float pointSize = getFloatOverLifetime( positionInTime, size ) * isAlive;","\t\t#ifdef HAS_PERSPECTIVE","\t\t\t\tfloat perspective = scale / length( mvPosition.xyz );","\t\t#else","\t\t\t\tfloat perspective = 1.0;","\t\t#endif","\t\tfloat pointSizePerspective = pointSize * perspective;","\t\t#ifdef COLORIZE","\t\t\t vec3 c = isAlive * getColorOverLifetime(","\t\t\t\t\t positionInTime,","\t\t\t\t\t unpackColor( color.x ),","\t\t\t\t\t unpackColor( color.y ),","\t\t\t\t\t unpackColor( color.z ),","\t\t\t\t\t unpackColor( color.w )","\t\t\t );","\t\t#else","\t\t\t vec3 c = vec3(1.0);","\t\t#endif","\t\tfloat o = isAlive * getFloatOverLifetime( positionInTime, opacity );","\t\tvColor = vec4( c, o );","\t\t#ifdef SHOULD_ROTATE_TEXTURE","\t\t\t\tvAngle = isAlive * getFloatOverLifetime( positionInTime, angle );","\t\t#endif","\t\t#ifdef SHOULD_CALCULATE_SPRITE","\t\t\t\tfloat framesX = textureAnimation.x;","\t\t\t\tfloat framesY = textureAnimation.y;","\t\t\t\tfloat loopCount = textureAnimation.w;","\t\t\t\tfloat totalFrames = textureAnimation.z;","\t\t\t\tfloat frameNumber = mod( (positionInTime * loopCount) * totalFrames, totalFrames );","\t\t\t\tfloat column = floor(mod( frameNumber, framesX ));","\t\t\t\tfloat row = floor( (frameNumber - column) / framesX );","\t\t\t\tfloat columnNorm = column / framesX;","\t\t\t\tfloat rowNorm = row / framesY;","\t\t\t\tvSpriteSheet.x = 1.0 / framesX;","\t\t\t\tvSpriteSheet.y = 1.0 / framesY;","\t\t\t\tvSpriteSheet.z = columnNorm;","\t\t\t\tvSpriteSheet.w = rowNorm;","\t\t#endif","\t\tgl_PointSize = pointSizePerspective;","\t\tgl_Position = u_Projection * mvPosition;",i.ShaderChunk.logdepthbuf_vert,"}"].join("\n"),fragment:[h.uniforms,i.ShaderChunk.common_frag,i.ShaderChunk.fog_pars_frag,i.ShaderChunk.logdepthbuf_pars_frag,h.varyings,h.branchAvoidanceFunctions,"void main() {","\t\tvec3 outgoingLight = vColor.xyz;","\t\t","\t\t#ifdef ALPHATEST","\t\t\t if ( vColor.w < float(ALPHATEST) ) discard;","\t\t#endif",h.rotateTexture,i.ShaderChunk.logdepthbuf_frag,"\t\toutgoingLight = vColor.xyz * rotatedTexture.xyz;","\t\tgl_FragColor = vec4( outgoingLight.xyz, rotatedTexture.w * vColor.w );",i.ShaderChunk.fog_frag,"}"].join("\n")},d=function(){function t(t){this.uuid=i.generateUUID();var e=f.types,r=a.valueOverLifetimeLength;for(var o in(t=f.ensureTypedArg(t,e.OBJECT,{})).position=f.ensureTypedArg(t.position,e.OBJECT,{}),t.velocity=f.ensureTypedArg(t.velocity,e.OBJECT,{}),t.acceleration=f.ensureTypedArg(t.acceleration,e.OBJECT,{}),t.radius=f.ensureTypedArg(t.radius,e.OBJECT,{}),t.drag=f.ensureTypedArg(t.drag,e.OBJECT,{}),t.rotation=f.ensureTypedArg(t.rotation,e.OBJECT,{}),t.color=f.ensureTypedArg(t.color,e.OBJECT,{}),t.opacity=f.ensureTypedArg(t.opacity,e.OBJECT,{}),t.size=f.ensureTypedArg(t.size,e.OBJECT,{}),t.angle=f.ensureTypedArg(t.angle,e.OBJECT,{}),t.wiggle=f.ensureTypedArg(t.wiggle,e.OBJECT,{}),t.maxAge=f.ensureTypedArg(t.maxAge,e.OBJECT,{}),this.type=f.ensureTypedArg(t.type,e.NUMBER,a.distributions.BOX),this.position={_value:f.ensureInstanceOf(t.position.value,i.Vector3,new i.Vector3),_spread:f.ensureInstanceOf(t.position.spread,i.Vector3,new i.Vector3),_spreadClamp:f.ensureInstanceOf(t.position.spreadClamp,i.Vector3,new i.Vector3),_distribution:f.ensureTypedArg(t.position.distribution,e.NUMBER,this.type),_randomise:f.ensureTypedArg(t.position.randomise,e.BOOLEAN,!1),_radius:f.ensureTypedArg(t.position.radius,e.NUMBER,10),_radiusScale:f.ensureInstanceOf(t.position.radiusScale,i.Vector3,new i.Vector3(1,1,1))},this.velocity={_value:f.ensureInstanceOf(t.velocity.value,i.Vector3,new i.Vector3),_spread:f.ensureInstanceOf(t.velocity.spread,i.Vector3,new i.Vector3),_distribution:f.ensureTypedArg(t.velocity.distribution,e.NUMBER,this.type),_randomise:f.ensureTypedArg(t.velocity.randomise,e.BOOLEAN,!1)},this.acceleration={_value:f.ensureInstanceOf(t.acceleration.value,i.Vector3,new i.Vector3),_spread:f.ensureInstanceOf(t.acceleration.spread,i.Vector3,new i.Vector3),_distribution:f.ensureTypedArg(t.acceleration.distribution,e.NUMBER,this.type),_randomise:f.ensureTypedArg(t.acceleration.randomise,e.BOOLEAN,!1)},this.drag={_value:f.ensureTypedArg(t.drag.value,e.NUMBER,0),_spread:f.ensureTypedArg(t.drag.spread,e.NUMBER,0),_randomise:f.ensureTypedArg(t.drag.randomise,e.BOOLEAN,!1)},this.wiggle={_value:f.ensureTypedArg(t.wiggle.value,e.NUMBER,0),_spread:f.ensureTypedArg(t.wiggle.spread,e.NUMBER,0)},this.rotation={_axis:f.ensureInstanceOf(t.rotation.axis,i.Vector3,new i.Vector3(0,1,0)),_axisSpread:f.ensureInstanceOf(t.rotation.axisSpread,i.Vector3,new i.Vector3),_angle:f.ensureTypedArg(t.rotation.angle,e.NUMBER,0),_angleSpread:f.ensureTypedArg(t.rotation.angleSpread,e.NUMBER,0),_static:f.ensureTypedArg(t.rotation.static,e.BOOLEAN,!1),_center:f.ensureInstanceOf(t.rotation.center,i.Vector3,this.position._value.clone()),_randomise:f.ensureTypedArg(t.rotation.randomise,e.BOOLEAN,!1)},this.maxAge={_value:f.ensureTypedArg(t.maxAge.value,e.NUMBER,2),_spread:f.ensureTypedArg(t.maxAge.spread,e.NUMBER,0)},this.color={_value:f.ensureArrayInstanceOf(t.color.value,i.Color3,new i.Color3(1,1,1)),_spread:f.ensureArrayInstanceOf(t.color.spread,i.Vector3,new i.Vector3),_randomise:f.ensureTypedArg(t.color.randomise,e.BOOLEAN,!1)},this.opacity={_value:f.ensureArrayTypedArg(t.opacity.value,e.NUMBER,1),_spread:f.ensureArrayTypedArg(t.opacity.spread,e.NUMBER,0),_randomise:f.ensureTypedArg(t.opacity.randomise,e.BOOLEAN,!1)},this.size={_value:f.ensureArrayTypedArg(t.size.value,e.NUMBER,1),_spread:f.ensureArrayTypedArg(t.size.spread,e.NUMBER,0),_randomise:f.ensureTypedArg(t.size.randomise,e.BOOLEAN,!1)},this.angle={_value:f.ensureArrayTypedArg(t.angle.value,e.NUMBER,0),_spread:f.ensureArrayTypedArg(t.angle.spread,e.NUMBER,0),_randomise:f.ensureTypedArg(t.angle.randomise,e.BOOLEAN,!1)},this.resetFlags={position:f.ensureTypedArg(t.position.randomise,e.BOOLEAN,!1)||f.ensureTypedArg(t.radius.randomise,e.BOOLEAN,!1),velocity:f.ensureTypedArg(t.velocity.randomise,e.BOOLEAN,!1),acceleration:f.ensureTypedArg(t.acceleration.randomise,e.BOOLEAN,!1)||f.ensureTypedArg(t.drag.randomise,e.BOOLEAN,!1),rotation:f.ensureTypedArg(t.rotation.randomise,e.BOOLEAN,!1),size:f.ensureTypedArg(t.size.randomise,e.BOOLEAN,!1),color:f.ensureTypedArg(t.color.randomise,e.BOOLEAN,!1),opacity:f.ensureTypedArg(t.opacity.randomise,e.BOOLEAN,!1),angle:f.ensureTypedArg(t.angle.randomise,e.BOOLEAN,!1)},this.updateFlags={},this.updateCounts={},this.updateMap={maxAge:"params",position:"position",velocity:"velocity",acceleration:"acceleration",drag:"acceleration",wiggle:"params",rotation:"rotation",size:"size",color:"color",opacity:"opacity",angle:"angle"},this.updateMap)this.updateMap.hasOwnProperty(o)&&(this.updateCounts[this.updateMap[o]]=0,this.updateFlags[this.updateMap[o]]=!1,this._createGetterSetters(this[o],o));f.ensureValueOverLifetimeCompliance(this.color,r,r),f.ensureValueOverLifetimeCompliance(this.opacity,r,r),f.ensureValueOverLifetimeCompliance(this.size,r,r),f.ensureValueOverLifetimeCompliance(this.angle,r,r),this.particleCount=f.ensureTypedArg(t.particleCount,e.NUMBER,100),this.duration=f.ensureTypedArg(t.duration,e.NUMBER,null),this.isStatic=f.ensureTypedArg(t.isStatic,e.BOOLEAN,!1),this.activeMultiplier=f.ensureTypedArg(t.activeMultiplier,e.NUMBER,1),this.direction=f.ensureTypedArg(t.direction,e.NUMBER,1),this.isLookAtCamera=f.ensureTypedArg(t.isLookAtCamera,e.BOOLEAN,!1),this.isLookAtCameraOnlyY=f.ensureTypedArg(t.isLookAtCameraOnlyY,e.BOOLEAN,!1),this.alive=f.ensureTypedArg(t.alive,e.BOOLEAN,!0),this.particlesPerSecond=0,this.calculatePPSValue(),this.age=0,this.group=null}var e=t.prototype;return e._createGetterSetters=function(t,e){var r=this;for(var i in t)if(t.hasOwnProperty(i)){var o=i.replace("_","");Object.defineProperty(t,o,{get:function(t){return function(){return this[t]}}(i),set:function(t){return function(i){var o=r.updateMap[e],n=this[t],s=a.valueOverLifetimeLength;"_randomise"===t?r.resetFlags[o]=i:(r.updateFlags[o]=!0,r.updateCounts[o]=0),this[t]=i,r.group.$updateDefines(r),Array.isArray(n)&&f.ensureValueOverLifetimeCompliance(r[e],s,s)}}(i)})}},e.calculatePPSValue=function(){var t=this.particleCount,e=this.maxAge._value+Math.abs(.5*this.maxAge._spread);return null!==this.duration?this.particlesPerSecond=t/Math.min(e,this.duration):this.particlesPerSecond=t/e,this},e.enable=function(){return this.alive=!0,this},e.disable=function(){return this.alive=!1,this},e.remove=function(){return null!==this.group?this.group.removeEmitter(this):console.error("Emitter does not belong to a group, cannot remove."),this},e.reset=function(t){},e._assignValue=function(){},e._assignPositionValue=function(t,e){var r=a.distributions,i=this.position,o=i._value,n=i._spread;switch(i._distribution){case r.BOX:f.getRandomVector3(t,e,o,n,i._spreadClamp);break;case r.SPHERE:f.getRandomVector3OnSphere(t,e,o,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x);break;case r.DISC:f.getRandomVector3OnDisc(t,e,o,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x);break;case r.LINE:f.getRandomVector3OnLine(t,e,o,n)}return t},e._assignForceValue=function(t,e,r,i){var o=a.distributions,n=this[r],s=n._value,l=n._spread;switch(n._distribution){case o.BOX:f.getRandomVector3(t,e,s,l);break;case o.SPHERE:f.getRandomDirectionVector3OnSphere(t,e,i[0],i[1],i[2],this.position._value,s.x,l.x);break;case o.DISC:f.getRandomDirectionVector3OnDisc(t,e,i[0],i[1],i[2],this.position._value,s.x,l.x);break;case o.LINE:f.getRandomVector3OnLine(t,e,s,l)}if("acceleration"===r){var u=f.clamp(f.randomFloat(this.drag._value,this.drag._spread),0,1);t[e+3]=u}return t},e._assignAbsLifetimeValue=function(t,e,r){var i=this[r];if(f.arrayValuesAreEqual(i._value)&&f.arrayValuesAreEqual(i._spread)){var a=Math.abs(f.randomFloat(i._value[0],i._spread[0]));t[e+0]=a,t[e+1]=a,t[e+2]=a,t[e+3]=a}else t[e+0]=Math.abs(f.randomFloat(i._value[0],i._spread[0])),t[e+1]=Math.abs(f.randomFloat(i._value[1],i._spread[1])),t[e+2]=Math.abs(f.randomFloat(i._value[2],i._spread[2])),t[e+3]=Math.abs(f.randomFloat(i._value[3],i._spread[3]));return t},e._assignAngleValue=function(t,e){var r=this.angle;if(f.arrayValuesAreEqual(r._value)&&f.arrayValuesAreEqual(r._spread)){var i=f.randomFloat(r._value[0],r._spread[0]);t[e+0]=i,t[e+1]=i,t[e+2]=i,t[e+3]=i}else t[e+0]=f.randomFloat(r._value[0],r._spread[0]),t[e+1]=f.randomFloat(r._value[1],r._spread[1]),t[e+2]=f.randomFloat(r._value[2],r._spread[2]),t[e+3]=f.randomFloat(r._value[3],r._spread[3]);return t},e._assignParamsValue=function(t,e,r){return t[e+0]=r?this.isStatic?1:0:1,t[e+1]=0,t[e+2]=f.randomFloat(this.maxAge._value,this.maxAge._spread),t[e+3]=f.randomFloat(this.wiggle._value,this.wiggle._spread),t},e._assignRotationValue=function(t,e,r,i,a){var o=f.getRotationAxis(g,this.rotation._axis,this.rotation._axisSpread);a?(o.x+=1,o.y+=1,o.z+=1,o.multiplyScalar(.5),m.setRGB(o.x,o.y,o.z),t[e+0]=m.getHex(),t[e+1]=f.randomFloat(this.rotation._angle,this.rotation._angleSpread),t[e+2]=this.rotation._static?0:1):(t[e+0]=o.x,t[e+1]=o.y,t[e+2]=o.z,t[e+3]=f.randomFloat(this.rotation._angle,this.rotation._angleSpread),t[e+4]=this.rotation._static?0:1),this.rotation._center.toArray(r,i)},e._assignColorValue=function(t,e,r){for(var i=this.color._value,a=this.color._spread,o=i.length,n=0;n<o;++n){var s=a[n];m.copy(i[n]),m.r+=Math.random()*s.x-.5*s.x,m.g+=Math.random()*s.y-.5*s.y,m.b+=Math.random()*s.z-.5*s.z,m.r=f.clamp(m.r,0,1),m.g=f.clamp(m.g,0,1),m.b=f.clamp(m.b,0,1),r?t[e+n]=m.getHex():m.toArray(t,e+3*n)}},t}(),g=new i.Vector3,m=new i.Color3,_=function(t){function e(e){var r;return(r=t.call(this,e)||this).activationIndex=0,r.attributeOffset=0,r.attributeEnd=0,r.activeParticleCount=0,r.attributes=null,r.bufferUpdateRanges={},r.attributeKeys=null,r.attributeCount=0,r}n(e,t);var r=e.prototype;return r.tick=function(t){if(!this.isStatic){var e=this.attributeOffset,r=e+this.particleCount,i=this.attributes.params.buffer.array,a=this.particlesPerSecond*this.activeMultiplier*t,o=this.activationIndex;if(this._resetBufferRanges(),this._checkParticleAges(e,r,i,t),!1!==this.alive){if(null!==this.duration&&this.age>this.duration)return this.alive=!1,void(this.age=0);var n=1===this.particleCount?o:0|o,s=Math.min(n+a,this.activationEnd),l=s-this.activationIndex|0,u=l>0?t/l:0;this._activateParticles(n,s,i,u),this.activationIndex+=a,this.activationIndex>r&&(this.activationIndex=e),this.age+=t}else this.age=0}},r.reset=function(t){if(this.age=0,this.alive=!1,!0===t){for(var e,r=this.attributeOffset,i=r+this.particleCount,a=this.attributes.params.buffer.array,o=this.attributes.params,n=i-1;n>=r;--n)a[e=4*n]=0,a[e+1]=0;o.updateRange.offset=0,o.updateRange.count=-1,o.needsUpdate=!0}return this},r._assignValue=function(t,e){var r,i,a,o,n;switch(t){case"position":r=this.attributes.position.buffer.array,this._assignPositionValue(r,this.attributes.position.size*e);break;case"velocity":case"acceleration":a=(r=this.attributes.position.buffer.array)[3*e+0],o=r[3*e+1],n=r[3*e+2],r=this.attributes[t].buffer.array,this._assignForceValue(r,this.attributes[t].size*e,t,[a,o,n]);break;case"size":case"opacity":r=this.attributes[t].buffer.array,this._assignAbsLifetimeValue(r,this.attributes[t].size*e,t);break;case"angle":r=this.attributes.angle.buffer.array,this._assignAngleValue(r,this.attributes.angle.size*e);break;case"params":r=this.attributes.params.buffer.array,this._assignParamsValue(r,this.attributes.params.size*e,!0);break;case"rotation":r=this.attributes.rotation.buffer.array,i=this.attributes.rotationCenter.buffer.array,this._assignRotationValue(r,this.attributes.rotation.size*e,i,this.attributes.rotationCenter.size*e,!0);break;case"color":r=this.attributes.color.buffer.array,this._assignColorValue(r,this.attributes.color.size*e,!0)}},r._resetParticle=function(t){for(var e,r,i=this.resetFlags,a=this.updateFlags,o=this.updateCounts,n=this.attributeKeys,s=this.attributeCount-1;s>=0;--s)r=a[e=n[s]],!0!==i[e]&&!0!==r||(this._assignValue(e,t),this._updateAttributeUpdateRange(e,t),!0===r&&o[e]===this.particleCount?(a[e]=!1,o[e]=0):1==r&&++o[e])},r._setBufferUpdateRanges=function(t){this.attributeKeys=t,this.attributeCount=t.length;for(var e=this.attributeCount-1;e>=0;--e)this.bufferUpdateRanges[t[e]]={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}},r._setAttributeOffset=function(t){this.attributeOffset=t,this.activationIndex=t,this.activationEnd=t+this.particleCount},r._updateAttributeUpdateRange=function(t,e){var r=this.bufferUpdateRanges[t];r.min=Math.min(e,r.min),r.max=Math.max(e,r.max)},r._resetBufferRanges=function(){for(var t,e=this.bufferUpdateRanges,r=this.bufferUpdateKeys,i=this.bufferUpdateCount-1;i>=0;--i)e[t=r[i]].min=Number.POSITIVE_INFINITY,e[t].max=Number.NEGATIVE_INFINITY},r._onRemove=function(){this.particlesPerSecond=0,this.attributeOffset=0,this.activationIndex=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.age=0},r._decrementParticleCount=function(){--this.activeParticleCount},r._incrementParticleCount=function(){++this.activeParticleCount},r._checkParticleAges=function(t,e,r,i){for(var a,o,n,s,l=e-1;l>=t;--l)0!==(s=r[a=4*l])&&(n=r[a+1],o=r[a+2],1===this.direction?(n+=i)>=o&&(n=0,s=0,this._decrementParticleCount()):(n-=i)<=0&&(n=o,s=0,this._decrementParticleCount()),r[a]=s,r[a+1]=n,this._updateAttributeUpdateRange("params",l))},r._activateParticles=function(t,e,r,i){for(var a,o,n=this.direction,s=t;s<e;++s)0!=r[a=4*s]&&1!==this.particleCount||(this._incrementParticleCount(),r[a]=1,this._resetParticle(s),o=i*(s-t),r[a+1]=-1===n?r[a+2]-o:o,this._updateAttributeUpdateRange("params",s))},e}(d),v=function(){function t(t){this.uuid=i.generateUUID();var e=f.types;t.texture=f.ensureTypedArg(t.texture,e.OBJECT,{}),this.fixedTimeStep=f.ensureTypedArg(t.fixedTimeStep,e.NUMBER,.016),this.hasPerspective=f.ensureTypedArg(t.hasPerspective,e.BOOLEAN,!0),this.colorize=f.ensureTypedArg(t.colorize,e.BOOLEAN,!0),this._emitters=[]}var e=t.prototype;return e.addEmitter=function(t){},e.removeEmitter=function(t){},e.tick=function(t){},e.dispose=function(){},e._setMaterial=function(t,e){var r=f.types;t.uniforms.tex=f.ensureInstanceOf(e.texture.value,i.Texture2D,y),t.blending=f.ensureTypedArg(e.blending,r.STRING,i.BLEND_TYPE.ADD),t.transparent=f.ensureTypedArg(e.transparent,r.BOOLEAN,!0),t.alphaTest=f.ensureTypedArg(e.alphaTest,r.NUMBER,0),t.depthWrite=f.ensureTypedArg(e.depthWrite,r.BOOLEAN,!1),t.depthTest=f.ensureTypedArg(e.depthTest,r.BOOLEAN,!0),t.fog=f.ensureTypedArg(e.fog,r.BOOLEAN,!0)},t}(),y=new i.Texture2D;y.image={data:new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]),width:2,height:2},y.magFilter=i.TEXTURE_FILTER.NEAREST,y.minFilter=i.TEXTURE_FILTER.NEAREST,y.generateMipmaps=!1;var A={position:3,acceleration:4,velocity:3,rotation:4,rotationCenter:3,params:4,size:4,angle:4,color:4,opacity:4},E=function(t){function e(e){var r,o=f,n=o.types;return e=f.ensureTypedArg(e,n.OBJECT,{}),(r=t.call(this,e)||this).maxParticleCount=o.ensureTypedArg(e.maxParticleCount,n.NUMBER,null),null===r.maxParticleCount&&console.warn("ParticleGroup: No maxParticleCount specified. Adding emitters after rendering will probably cause errors."),r.textureFrames=f.ensureInstanceOf(e.texture.frames,i.Vector2,new i.Vector2(1,1)),r.textureFrames.max(new i.Vector2(1,1)),r.textureFrameCount=f.ensureTypedArg(e.texture.frameCount,n.NUMBER,r.textureFrames.x*r.textureFrames.y),r.textureLoop=f.ensureTypedArg(e.texture.loop,n.NUMBER,1),r.material=new i.ShaderMaterial({defines:{HAS_PERSPECTIVE:r.hasPerspective,COLORIZE:r.colorize,VALUE_OVER_LIFETIME_LENGTH:a.valueOverLifetimeLength,SHOULD_ROTATE_TEXTURE:!1,SHOULD_ROTATE_PARTICLES:!1,SHOULD_WIGGLE_PARTICLES:!1,SHOULD_CALCULATE_SPRITE:r.textureFrames.x>1||r.textureFrames.y>1},uniforms:{tex:null,textureAnimation:[r.textureFrames.x,r.textureFrames.y,r.textureFrameCount,Math.max(Math.abs(r.textureLoop),1)],scale:o.ensureTypedArg(e.scale,n.NUMBER,300),deltaTime:0,runTime:0},vertexShader:p.vertex,fragmentShader:p.fragment}),r._setMaterial(r.material,e),r.material.drawMode=i.DRAW_MODE.POINTS,r.uniforms=r.material.uniforms,r.defines=r.material.defines,r.geometry=new i.Geometry,r.geometry.addGroup(0,r.particleCount,0),r.mesh=new i.Mesh(r.geometry,[r.material]),r.mesh.frustumCulled=!1,r.attributes={position:null,acceleration:null,velocity:null,rotation:null,rotationCenter:null,params:null,size:null,angle:null,color:null,opacity:null},r.attributeKeys=Object.keys(r.attributes),r.attributeCount=r.attributeKeys.length,r._attributesNeedRefresh=!1,r._attributesNeedDynamicReset=!1,r.particleCount=0,r}n(e,t);var r=e.prototype;return r.addEmitter=function(t){if(t instanceof _!=!1)if(this._emitters.indexOf(t)>-1)console.error("ParticleEmitter already exists in this group. Will not add again.");else{if(null===t.group){var e=this.attributes,r=this.particleCount,a=r+t.particleCount;for(var o in this.particleCount=a,null!==this.maxParticleCount&&this.particleCount>this.maxParticleCount&&console.warn("ParticleGroup: maxParticleCount exceeded. Requesting",this.particleCount,"particles, can support only",this.maxParticleCount),t._setBufferUpdateRanges(this.attributeKeys),t._setAttributeOffset(r),t.group=this,t.attributes=this.attributes,e)if(e.hasOwnProperty(o)){var n=e[o],s=null!==this.maxParticleCount?this.maxParticleCount:this.particleCount;if(null!==n&&null!==n.buffer.array){if(n.buffer.array.length!==s*n.size){var l=n.buffer.array.length,u=s*n.size;if(u<l)n.buffer.array=n.buffer.array.subarray(0,u);else{var c=n.buffer.array,f=new Float32Array(u);f.set(c),n.buffer.array=f}n.buffer.count=s,n.buffer.version++}}else e[o]=new i.Attribute(new i.Buffer(new Float32Array(s*A[o]),A[o])),e[o].buffer.usage=i.BUFFER_USAGE.DYNAMIC_DRAW}for(var h=r;h<a;++h)t._assignValue("position",h),t._assignValue("velocity",h),t._assignValue("acceleration",h),t._assignValue("size",h),t._assignValue("opacity",h),t._assignValue("angle",h),t._assignValue("params",h),t._assignValue("rotation",h),t._assignValue("color",h);return this._applyAttributesToGeometry(),this._emitters.push(t),this.$updateDefines(t),this._attributesNeedRefresh=!0,this}console.error("ParticleEmitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of ParticleEmitter. Was provided with:",t)},r.removeEmitter=function(t){var e=this._emitters.indexOf(t);if(t instanceof _!=!1)if(-1!==e){for(var r=t.attributeOffset,i=r+t.particleCount,a=this.attributes.params.buffer.array,o=r;o<i;++o)a[4*o]=0,a[4*o+1]=0;for(var n in this._emitters.splice(e,1),this.attributes)if(this.attributes.hasOwnProperty(n)){for(var s=this.attributes[n],l=r*s.size,u=i*s.size,c=[],f=s.buffer.array,h=0;h<f.length;++h)(h<l||h>=u)&&c.push(f[h]);(f=f.subarray(0,c.length)).set(c),this.attributes[n].buffer.array=f}for(var p=this._emitters.length-1;p>=e;p--){var d=this._emitters[p].attributeOffset-t.particleCount;this._emitters[p]._setAttributeOffset(d)}this.particleCount-=t.particleCount,this.geometry.groups[0].count=this.particleCount,t._onRemove(),this._attributesNeedRefresh=!0}else console.error("ParticleEmitter does not exist in this group. Will not remove.");else console.error("`emitter` argument must be instance of ParticleEmitter. Was provided with:",t)},r.tick=function(t){var e,r,a=this._emitters,o=a.length,n=t||this.fixedTimeStep,s=this.attributeKeys,l=this.attributes;if(this.uniforms.runTime+=n,this.uniforms.deltaTime=n,0!==o||!1!==this._attributesNeedRefresh||!1!==this._attributesNeedDynamicReset){for(r=0;r<o;++r)a[r].tick(n);for(e=this.attributeCount-1;e>=0;--e){var u=s[e],c=1/0,f=-1/0;for(r=0;r<o;++r){var h=a[r].bufferUpdateRanges[u];c=Math.min(h.min,c),f=Math.max(h.max,f)}if(f-c>0){var p=l[u];p.buffer.updateRange.offset=c*p.size,p.buffer.updateRange.count=Math.min((f-c+1)*p.size,p.buffer.array.length),p.buffer.version++}}if(!0===this._attributesNeedDynamicReset){for(e=this.attributeCount-1;e>=0;--e)l[s[e]].buffer.usage=i.BUFFER_USAGE.DYNAMIC_DRAW;this._attributesNeedDynamicReset=!1}if(!0===this._attributesNeedRefresh){for(e=this.attributeCount-1;e>=0;--e)l[s[e]].buffer.updateRange.offset=0,l[s[e]].buffer.updateRange.count=-1,l[s[e]].buffer.usage=i.BUFFER_USAGE.STATIC_DRAW,l[s[e]].buffer.version++;this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!0}}},r.dispose=function(){return this.mesh.geometry.dispose(),this.mesh.material[0].dispose(),this},r.$updateDefines=function(){for(var t,e=this._emitters,r=this.defines,i=e.length-1;i>=0;--i)t=e[i],r.SHOULD_CALCULATE_SPRITE||(r.SHOULD_ROTATE_TEXTURE=r.SHOULD_ROTATE_TEXTURE||!!Math.max(Math.max.apply(null,t.angle.value),Math.max.apply(null,t.angle.spread))),r.SHOULD_ROTATE_PARTICLES=r.SHOULD_ROTATE_PARTICLES||!!Math.max(t.rotation.angle,t.rotation.angleSpread),r.SHOULD_WIGGLE_PARTICLES=r.SHOULD_WIGGLE_PARTICLES||!!Math.max(t.wiggle.value,t.wiggle.spread);this.material.needsUpdate=!0},r._applyAttributesToGeometry=function(){var t,e=this.attributes,r=this.geometry,i=r.attributes;for(var a in e)e.hasOwnProperty(a)&&(t=e[a],i["position"===a?"a_Position":a]||r.addAttribute("position"===a?"a_Position":a,t));this.geometry.version++,this.geometry.groups[0].count=this.particleCount},e}(v),x={name:"mesh_particle_shader",uniforms:{tex:null},vertexShader:"\n\t\t#include <common_vert>\n\n\t\tattribute vec3 mcol0;\n\t\tattribute vec3 mcol1;\n\t\tattribute vec3 mcol2;\n\t\tattribute vec3 mcol3;\n\t\tattribute vec4 color;\n\n\t\tattribute vec2 a_Uv;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 varyColor;\n\n\t\t#include <logdepthbuf_pars_vert>\n\n\t\tvoid main() {\n\t\t\tmat4 matrix = mat4(\n\t\t\t\tvec4(mcol0, 0),\n\t\t\t\tvec4(mcol1, 0),\n\t\t\t\tvec4(mcol2, 0),\n\t\t\t\tvec4(mcol3, 1)\n\t\t\t);\n\n\t\t\tvec4 worldPosition = u_Model * matrix * vec4(a_Position, 1.0);\n\t\t\tgl_Position = u_ProjectionView * worldPosition;\n\n\t\t\tvaryColor = color;\n\t\t\tvUv = a_Uv;\n\n\t\t\t#include <logdepthbuf_vert>\n\t\t}\n\t",fragmentShader:"\n\t\tuniform sampler2D tex;\n\n\t\t#include <common_frag>\n\t\t#include <fog_pars_frag>\n\t\t#include <logdepthbuf_pars_frag>\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 varyColor;\n\n\t\tvoid main() {\n\t\t\t#include <logdepthbuf_frag>\n\n\t\t\tgl_FragColor = varyColor * texture2D(tex, vUv);\n\n\t\t\t#include <fog_frag>\n\t\t}\n\t"},b=function(){function t(){this._matrix=new i.Matrix4,this._color=new i.Color3(1,1,1),this._opacity=1,this._originPosition=[0,0,0],this._originVelocity=[0,0,0],this._originAcceleration=[0,0,0,0],this._originOpacityArray=[],this._originSizeArray=[],this._originAngleArray=[],this._originColorArray=[1,1,1,1,1,1,1,1,1,1,1,1],this._originParams=[0,0,0,0],this._originRotation=[0,1,0,0,0],this._originRotationCenter=[0,0,0]}var e=t.prototype;return e.isAlive=function(){return!!this._originParams[0]},e.tick=function(t,e,r){this._originParams[1]+=t,this._originParams[1]>this._originParams[2]&&(this._originParams[0]=0),0!==this._originParams[0]?this._update(e,r):this._originParams[1]=0},e.submit=function(t,e){var r=16*e,i=this._matrix.elements;t[r]=i[0],t[r+1]=i[1],t[r+2]=i[2],t[r+3]=i[4],t[r+4]=i[5],t[r+5]=i[6],t[r+6]=i[8],t[r+7]=i[9],t[r+8]=i[10],t[r+9]=i[12],t[r+10]=i[13],t[r+11]=i[14],t[r+12]=this._color.r,t[r+13]=this._color.g,t[r+14]=this._color.b,t[r+15]=this._opacity},e._update=function(t,e){var r=this._originParams[1],i=r/this._originParams[2],o=O.fromArray(this._originAcceleration);if(e.SHOULD_DRAG_PARTICLES){var n=1-.5*i*this._originAcceleration[3];o.multiplyScalar(n)}P.fromArray(this._originVelocity).multiplyScalar(r);var s=o.multiplyScalar(r*r*.5);if(P.add(C.fromArray(this._originPosition)).add(s),e.SHOULD_WIGGLE_PARTICLES){var l=i*this._originParams[3]*Math.PI,u=Math.sin(l),c=Math.cos(l);P.x+=u,P.y+=c,P.z+=u}if(e.SHOULD_ROTATE_PARTICLES){var h=this._originRotation[3];if(0!==h){var p=0;p=0===this._originRotation[4]?h:f.lerp(0,h,i);var d=O.fromArray(this._originRotation),g=R.makeRotationAxis(d,p),m=O.fromArray(this._originRotationCenter).sub(P);m.applyMatrix4(g),P.fromArray(this._originRotationCenter).sub(m)}}if(S.set(1,1,1),e.SHOULD_SIZE_PARTICLES){var _=M(i,this._originSizeArray);S.set(_,_,_)}if(e.isLookAtCamera||e.isLookAtCameraOnlyY)e.isLookAtCamera?L.copy(t.quaternion):e.isLookAtCameraOnlyY&&(R.getInverse(e.group.mesh.worldMatrix),R.multiply(t.worldMatrix),O.setFromMatrixPosition(R),C.copy(P).sub(O),C.y=0,L.setFromUnitVectors(O.set(0,0,-1),C.normalize()));else if(e.SHOULD_ANGLE_PARTICLES){var v=M(i,this._originAngleArray);T.set(v,v,v),L.setFromEuler(T,!1)}this._matrix.transform(P,S,L),e.SHOULD_COLORIZE_PARTICLES?(!function(t,e,r){var i=a.valueOverLifetimeLength-1;if(t<=0)r.fromArray(e,0);else if(t>=1)r.fromArray(e,3*i);else for(var o,n,s,l=t*i,u=0;u<i;u++)if(l>u&&l<u+1){o=l-u,s=(n=3*u)+3,r.r=o*(e[s+0]-e[n+0])+e[n+0],r.g=o*(e[s+1]-e[n+1])+e[n+1],r.b=o*(e[s+2]-e[n+2])+e[n+2];break}}(i,this._originColorArray,this._color),this._opacity=M(i,this._originOpacityArray)):(this._color.setRGB(1,1,1),this._opacity=1)},t}(),O=new i.Vector3,C=new i.Vector3,T=new i.Euler,R=new i.Matrix4,P=new i.Vector3,L=new i.Quaternion,S=new i.Vector3;function M(t,e){var r=a.valueOverLifetimeLength-1,i=0;if(t<=0)i=0;else if(t>=1)i=e[r];else for(var o=t*r,n=0;n<r;n++)if(o>n&&o<n+1){i+=f.lerp(e[n],e[n+1],o-n);break}return i}var I=function(t){function e(e){var r;return(r=t.call(this,e)||this)._activeParticles=new Array,r._particlePool=new Array,r}n(e,t);var r=e.prototype;return r.tick=function(t,e){if(this.isStatic){for(var r=0,i=this._activeParticles.length;r<i;r++)if(this._activeParticles[r].isAlive()){var a=this.group;this._activeParticles[r].submit(a.$instanceBuffer.array,a.$allocBufferIndex())}}else if(!1!==this.alive){var o=null!==this.duration&&this.age>this.duration;if(!o)for(var n=this._activeParticles.length,s=this.particlesPerSecond*this.activeMultiplier*t,l=Math.min(n+s,this.particleCount)-n,u=0;u<l;u++){var c=this._particlePool.length<=0?new b:this._particlePool.shift();this._resetParticle(c),this._activeParticles.push(c)}for(var f=0,h=this._activeParticles.length;f<h;f++)if(this._activeParticles[f].tick(t,e,this),this._activeParticles[f].isAlive()){var p=this.group;this._activeParticles[f].submit(p.$instanceBuffer.array,p.$allocBufferIndex())}else this._particlePool.push(this._activeParticles[f]),this._activeParticles.splice(f,1),h--,f--;o&&this._activeParticles.length<=0&&(this.alive=!1,this.age=0),this.alive&&(this.age+=t)}else this.age=0},r.reset=function(t){this.alive=!1,this.age=0,t&&(this._activeParticles=[],this._particlePool=[])},r.$updateFlags=function(t){this.SHOULD_DRAG_PARTICLES=!!Math.max(this.drag._value,this.drag._spread),this.SHOULD_WIGGLE_PARTICLES=!!Math.max(this.wiggle._value,this.wiggle._spread),this.SHOULD_ROTATE_PARTICLES=!!Math.max(this.rotation._angle,this.rotation._angleSpread),this.SHOULD_COLORIZE_PARTICLES=t.colorize,this.SHOULD_SIZE_PARTICLES=!0,this.SHOULD_ANGLE_PARTICLES=!0},r._assignValue=function(t,e,r,i){switch(t){case"position":this._assignPositionValue(e,0);break;case"velocity":case"acceleration":this._assignForceValue(e,0,t,r);break;case"size":case"opacity":this._assignAbsLifetimeValue(e,0,t);break;case"angle":this._assignAngleValue(e,0);break;case"params":this._assignParamsValue(e,0);break;case"rotation":this._assignRotationValue(e,0,i,0);break;case"color":this._assignColorValue(e,0)}},r._resetParticle=function(t){this._assignValue("position",t._originPosition),this._assignValue("velocity",t._originVelocity,t._originPosition),this._assignValue("acceleration",t._originAcceleration,t._originPosition),this._assignValue("opacity",t._originOpacityArray),this._assignValue("size",t._originSizeArray),this._assignValue("angle",t._originAngleArray),this._assignValue("color",t._originColorArray),this._assignValue("params",t._originParams),this._assignValue("rotation",t._originRotation,void 0,t._originRotationCenter)},e}(d),V=function(t){function e(e){var r,a=f.types;e=f.ensureTypedArg(e,a.OBJECT,{}),r=t.call(this,e)||this,void 0===e.maxParticleCount&&(console.warn("MeshParticleGroup: options.maxParticleCount is not provided, set to 1000 by default."),e.maxParticleCount=1e3),r.maxParticleCount=e.maxParticleCount,e.geometry&&e.geometry instanceof i.Geometry||(console.warn("MeshParticleGroup: options.geometry is not provided, set a box geometry by default."),e.geometry=new i.BoxGeometry(1,1,1));var o=function(t,e){var r=t.clone(),a=new i.Buffer(new Float32Array(16*e),16);a.usage=i.BUFFER_USAGE.DYNAMIC_DRAW;var o=new i.Attribute(a,3,0),n=new i.Attribute(a,3,3),s=new i.Attribute(a,3,6),l=new i.Attribute(a,3,9),u=new i.Attribute(a,4,12);return o.divisor=1,n.divisor=1,s.divisor=1,l.divisor=1,u.divisor=1,r.addAttribute("mcol0",o),r.addAttribute("mcol1",n),r.addAttribute("mcol2",s),r.addAttribute("mcol3",l),r.addAttribute("color",u),r}(e.geometry,r.maxParticleCount),n=new i.ShaderMaterial(x);return r._setMaterial(n,e),r.mesh=new i.Mesh(o,n),r.mesh.frustumCulled=!1,r.$instanceBuffer=o.attributes.mcol0.buffer,r._geometry=o,r._particleCount=0,r._aliveParticleCount=0,r}n(e,t);var r,a,s,l=e.prototype;return l.addEmitter=function(t){if(t instanceof I!=!1)if(this._emitters.indexOf(t)>-1)console.error("MeshParticleEmitter already exists in this group. Will not add again.");else{if(null===t.group)return this._particleCount+=t.particleCount,this._particleCount>this.maxParticleCount&&console.warn("MeshParticleGroup: maxParticleCount exceeded. Requesting",this._particleCount,"particles, can support only",this.maxParticleCount),t.group=this,this._emitters.push(t),this.$updateDefines(t),this;console.error("MeshParticleEmitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of MeshParticleEmitter. Was provided with:",t)},l.removeEmitter=function(t){var e=this._emitters.indexOf(t);if(t instanceof I!=!1){if(-1!==e)return this._particleCount-=t.particleCount,t.group=null,this._emitters.splice(e,1),this;console.error("MeshParticleEmitter does not exist in this group. Will not remove.")}else console.error("`emitter` argument must be instance of MeshParticleEmitter. Was provided with:",t)},l.tick=function(t,e){var r=this._emitters,i=r.length,a=t||this.fixedTimeStep;if(0!==i){this._aliveParticleCount=0;for(var o=0;o<i;o++)r[o].tick(a,e);this.$instanceBuffer.version++,this._geometry.instanceCount=this._aliveParticleCount}},l.dispose=function(){this.mesh.geometry.dispose(),this.mesh.material.dispose();for(var t=0,e=this._emitters.length;t<e;t++)this._emitters[t].group=null;return this._emitters=[],this._particleCount=0,this._aliveParticleCount=0,this},l.$updateDefines=function(t){t.$updateFlags(this)},l.$allocBufferIndex=function(){return this._aliveParticleCount++},r=e,(a=[{key:"particleCount",get:function(){return this._particleCount}},{key:"aliveParticleCount",get:function(){return this._aliveParticleCount}}])&&o(r.prototype,a),s&&o(r,s),Object.defineProperty(r,"prototype",{writable:!1}),e}(v);t.MeshParticleEmitter=I,t.MeshParticleGroup=V,t.ParticleEmitter=_,t.ParticleGroup=E,t.ParticleProperties=a,Object.defineProperty(t,"__esModule",{value:!0})}));
